---
import Layout from '../layouts/Layout.astro';
import HeaderHeroContainer from '../components/sections/HeaderHeroContainer.astro';
import GetInTouch from '../components/sections/GetInTouch.astro';
import Footer from '../components/layout/Footer.astro';
import CaseStudyCard from '../components/cards/CaseStudyCard.astro';
import { getCollection } from 'astro:content';
import cardImage from '../assets/CardImage.svg';

const caseStudies = await getCollection('case-studies');

// Returns a Date object or null if invalid
function parseUKDate(dateString: string | undefined): Date | null {
  if (!dateString) return null;
  
  const parts = dateString.split('/');
  if (parts.length !== 3) return null;
  
  const day = parseInt(parts[0], 10);
  const monthRaw = parseInt(parts[1], 10);
  const year = parseInt(parts[2], 10);
  
  // Validate all parts are numbers
  if (isNaN(day) || isNaN(monthRaw) || isNaN(year)) return null;
  
  // Validate month is between 1 and 12
  if (monthRaw < 1 || monthRaw > 12) return null;
  
  const month = monthRaw - 1; // Month is 0-indexed in Date
  const date = new Date(year, month, day);
  
  // Validate the date was created correctly 
  if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
    return null;
  }
  
  return date;
}

// Sort case studies by date descending (newest first)
const sortedCaseStudies = [...caseStudies].sort((a, b) => {
  const dateA = parseUKDate(a.data.date);
  const dateB = parseUKDate(b.data.date);
  
  // If both have valid dates, compare them
  if (dateA && dateB) {
    return dateB.getTime() - dateA.getTime(); 
  }
  
  // If only A has a date, it comes first
  if (dateA && !dateB) return -1;
  
  // If only B has a date, it comes first
  if (!dateA && dateB) return 1;
  
  // If neither has a date, maintain original order
  return 0;
});

// Array with case studies + 2 placeholder cards
const allCards = [...sortedCaseStudies];
while (allCards.length < sortedCaseStudies.length + 2) {
  allCards.push(null);
}
---

<Layout title="Case studies">
  <HeaderHeroContainer 
    title="Case studies" 
    subtitle="A brief description of the case studies here and the types of organisations that we work with. Should be no more than two sentences."
    icon="case-studies" 
  />
  <main id="content">
    <section class="section section-intro py-10 lg:py-12">
      <div class="container">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-stretch">
          {allCards.map((entry, index) => {
            if (entry) {
              const slug = entry.id.replace(/\.md$/, '');
              const customer = slug === 'infosecurity' ? 'Infosec at Neontribe' : (entry.data.customer || '');
              return (
                <CaseStudyCard
                  customer={customer}
                  title={entry.data.title}
                  summary={entry.data.description}
                  imageSrc={cardImage}
                  altText={entry.data.title}
                  linkHref={`/case-studies/${slug}`}
                />
              );
            } else {
              // Placeholder card
              return (
                <CaseStudyCard
                  customer="Client Name"
                  title="Case Study Title"
                  summary="A brief description of the project problem and the process we took to solve it."
                  imageSrc={cardImage}
                  altText="Case study placeholder"
                  linkHref="/case-studies/arc"
                />
              );
            }
          })}
        </div>
      </div>
    </section>
  </main>
  <div class="bg-bg-dark w-full">
    <GetInTouch />
    <Footer />
  </div>
</Layout>


