---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import GetInTouch from '../../components/sections/GetInTouch.astro';
import QuoteCard from '../../components/Testimonials/QuoteCard.astro';
import smallLensIcon from '../../content/case-studies/images/Small-lens.svg';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies');
  return caseStudies.map((entry) => {
    const slug = entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'case-studies'>;
}

const { entry } = Astro.props;
const slug = Astro.params.slug;

const { Content } = await entry.render();
const {
  title,
  description,
  customer,
  categories = [],
  statistic,
  heroImage,
  heroImageAlt,
  tags = [],
  quote,
  quoteAuthor,
  quoteOrganisation,
  quoteAvatar,
} = entry.data;

// Special exception for infosecurity case study
const displayCustomer = slug === 'infosecurity' ? 'Infosec at Neontribe' : customer;
---

<Layout title={title} description={description}>
  <Header />
  <!-- Hero Section with Dark Background and Overlapping White Intro -->
  <div class="relative" style="overflow: visible;">
    <!-- Dark Hero Section -->
    <section class="section section-dark pt-8 sm:pt-20 md:pt-32 sm:pb-40 md:pb-48 lg:pt-40 lg:pb-86 relative" aria-label="Case study hero">
      <div class="container">
        <div class="mx-auto relative max-w-[1200px] sm:min-h-[280px] md:min-h-[320px] sm:h-[280px] md:h-[320px]">
          <div class="grid grid-cols-1 sm:grid-cols-12 gap-6 md:gap-8 items-start">
            <!-- Left Column: Title, Customer, Categories -->
            <div class="sm:col-span-8 lg:col-span-7 relative z-10">
              <h1 class="text-text-light mb-4 md:mb-6 leading-tight case-study-title" style="font-family: var(--font-button); font-weight: var(--font-regular);">
                {title}
              </h1>
              
              {displayCustomer ? (
                <p class="mb-4 md:mb-6 leading-normal" style="font-family: var(--font-button); font-weight: var(--font-regular); font-size: var(--text-xl); color: #87FAE7;">
                  {displayCustomer}
                </p>
              ) : (
                <div class="mb-4 md:mb-6" style="height: 0;"></div>
              )}
              
              {categories.length > 0 ? (
                <p class="mb-8 md:mb-12 leading-normal" style="font-family: var(--font-body); font-weight: var(--font-regular); font-size: var(--text-xl); color: #FFFFFF;">
                  Categories: {categories.join(', ')}
                </p>
              ) : (
                <div class="mb-8 md:mb-12" style="height: 0;"></div>
              )}
            </div>
            
            <!-- Right Column: Spacer for absolute positioned image -->
            <div class="md:col-span-4 lg:col-span-5"></div>
          </div>
          
        </div>
      </div>
    </section>

    <!-- Mobile Hero Image (in document flow, only for very small screens) -->
    {heroImage && (
      <div class="sm:hidden flex justify-center -mt-16 mb-8" style="padding: 0 1.5rem;">
        <div class="mobile-image-container" style="max-width: 333px; width: 100%; aspect-ratio: 333 / 484;">
          <img
            src={heroImage.src}
            alt={heroImageAlt || `${title} - case study hero image`}
            class="block h-auto w-full drop-shadow-xl"
            loading="eager"
            style="object-fit: contain;"
          />
        </div>
      </div>
    )}

    <!-- White Introduction Section (overlapping) -->
    <section class="section section-light -mt-16 sm:-mt-20 md:-mt-24 lg:-mt-32 relative z-10 pt-8 md:pt-12 md:pb-12" style="overflow: visible;">
      <div class="container">
        <div class="mx-auto relative" style="max-width: 1200px;">
          <div class="grid grid-cols-1 sm:grid-cols-12 gap-6 md:gap-8">
            <!-- Left Column: Intro Text -->
            <div class="sm:col-span-8 lg:col-span-7 relative z-10 sm:mt-0">
              {description && (
                <p class="text-text-dark leading-relaxed" style="font-family: var(--font-body); font-weight: var(--font-bold); font-size: var(--text-xl);">
                  {description}
                </p>
              )}
            </div>
            <!-- Right Column: Spacer for image overlap -->
            <div class="sm:col-span-4 lg:col-span-5"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Tablet/Desktop Hero Image Container (visible from 640px+) -->
    {heroImage && (
      <div
        class="
          hidden sm:block
          pointer-events-none
          absolute sm:top-40 md:top-48 lg:top-52
          w-full
          hero-image-overlay
        "
        style="max-width: 1200px; left: 50%; transform: translateX(-50%); padding: 0 1.5rem; z-index: 30;"
        aria-hidden="true"
      >
        <div class="flex justify-end">
          <div class="mobile-image-container" style="width: 333px; height: 484px;">
            <img
              src={heroImage.src}
              alt={heroImageAlt || `${title} - case study hero image`}
              class="
                block h-auto pointer-events-auto w-full
                drop-shadow-xl
              "
              loading="eager"
            />
          </div>
        </div>
      </div>
    )}
  </div>

  <!-- Main Content Section with Light Grey Background -->
  <main id="content" class="section section-intro pt-6 pb-12 md:py-16">
    <div class="container">
      <div class="mx-auto" style="max-width: 1200px;">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
          <!-- Left Column: Main Text Content -->
          <div class="md:col-span-7 lg:col-span-8 order-1">
            <div class="case-study-content markdown-content">
              <Content />
            </div>
          </div>
          
          <!-- Right Column: Placeholder Containers -->
          <div class="md:col-span-5 lg:col-span-4 order-2 pt-8">
            <div class="flex flex-col gap-6 case-study-sidebar">
              <!-- Quote Card -->
              {quote && quoteAuthor && quoteOrganisation ? (
                <div>
                  <h3 class="quote-section-heading" style="font-family: var(--font-button); font-weight: var(--font-regular); font-size: var(--text-lg); margin-bottom: var(--typography-spacing-sm);">
                    {quoteOrganisation} say:
                  </h3>
                  <QuoteCard
                    quote={quote}
                    customerName={quoteAuthor}
                    customerOrganisation={quoteOrganisation}
                    avatar={quoteAvatar ? { src: quoteAvatar.src, alt: `${quoteAuthor} from ${quoteOrganisation}` } : undefined}
                  />
                </div>
              ) : null}
              
              <!-- Black Container -->
              <div class="statistics-block">
                <!-- Search Icon SVG -->
                <img 
                  src={smallLensIcon.src} 
                  alt="Statistics icon" 
                  width="50.24" 
                  height="49.93" 
                  class="flex-shrink-0"
                />
                {statistic ? (
                  <p class="statistics-text">
                    {statistic}
                  </p>
                ) : (
                  <p class="statistics-text">
                    <!-- Placeholder for statistic -->
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div class="bg-bg-dark w-full">
    <GetInTouch />
    <Footer />
  </div>
</Layout>

<style>
  /* Responsive case study title sizing */
  .case-study-title {
    font-size: 28px; /* Mobile: 28px - reduced from 48px */
    line-height: 1.2;
  }
  
  @media (min-width: 640px) {
    .case-study-title {
      font-size: 36px; /* Small tablet: 36px */
    }
  }
  
  @media (min-width: 768px) {
    .case-study-title {
      font-size: 40px; /* Tablet: 40px */
    }
  }
  
  @media (min-width: 1024px) {
    .case-study-title {
      font-size: 48px; /* Desktop: 48px (var(--text-5xl)) */
    }
  }
  
  /* Hero image overlay - ensure it appears above text */
  .hero-image-overlay {
    z-index: 30 !important;
  }
  
  /* Position image for small tablets (640px+) */
  @media (min-width: 640px) and (max-width: 767px) {
    .hero-image-overlay {
      top: 10rem !important; /* Position image to overlap sections */
      z-index: 30 !important;
    }
    
    /* Add bottom padding to dark section to accommodate image */
    section.section-dark {
      padding-bottom: 28rem !important;
    }
    
    /* Ensure text columns have proper spacing */
    section.section-dark [class*="sm:col-span-8"] {
      padding-right: 1.5rem;
    }
    
    section.section-light [class*="sm:col-span-8"] {
      padding-right: 1.5rem;
    }
  }
  
  /* Fix layout issues on tablet - ensure image appears above text */
  @media (min-width: 768px) and (max-width: 1023px) {
    /* Adjust image positioning for tablet */
    .hero-image-overlay {
      top: 12rem !important; /* Position image to overlap sections */
      z-index: 30 !important; /* Ensure image is above text */
    }
    
    /* Add bottom padding to dark section to accommodate image */
    section.section-dark {
      padding-bottom: 30rem !important; /* More space for image on tablet */
    }
    
    /* Ensure text columns have proper spacing on tablet */
    section.section-dark [class*="sm:col-span-8"],
    section.section-dark [class*="md:col-span-8"] {
      padding-right: 1.5rem;
    }
    
    /* Add padding to intro text section on tablet */
    section.section-light [class*="sm:col-span-8"],
    section.section-light [class*="md:col-span-8"] {
      padding-right: 1.5rem;
    }
    
    /* Prevent title overflow on tablet */
    .case-study-title {
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  }
  
  /* Desktop and larger screens - keep original positioning (handled by Tailwind classes) */
  @media (min-width: 1024px) {
    .hero-image-overlay {
      /* Original positioning maintained via Tailwind classes md:top-48 lg:top-52 */
      z-index: 30 !important;
    }
  }
  
  /* Ensure text sections have lower z-index so image appears above */
  section.section-dark .relative.z-10 {
    z-index: 10;
    position: relative;
  }
  
  section.section-light .relative.z-10 {
    z-index: 10;
    position: relative;
  }
  
  /* On desktop, ensure image is above text */
  @media (min-width: 1024px) {
    .hero-image-overlay {
      z-index: 30 !important;
    }
  }
</style>
