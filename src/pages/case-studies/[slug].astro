---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import GetInTouch from '../../components/sections/GetInTouch.astro';
import QuoteCard from '../../components/Testimonials/QuoteCard.astro';
import smallLensIcon from '../../content/case-studies/images/Small-lens.svg';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies');
  return caseStudies.map((entry) => {
    const slug = entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'case-studies'>;
}

const { entry } = Astro.props;
const slug = Astro.params.slug;

const { Content } = await entry.render();
const {
  title,
  description,
  customer,
  categories = [],
  statistic,
  heroImage,
  heroImageAlt,
  tags = [],
} = entry.data;

// Special exception for infosecurity case study
const displayCustomer = slug === 'infosecurity' ? 'Infosec at Neontribe' : customer;
---

<Layout title={title} description={description}>
  <Header />
  <!-- Hero Section with Dark Background and Overlapping White Intro -->
  <div class="relative" style="overflow: visible;">
    <!-- Dark Hero Section -->
    <section class="section section-dark pt-8 pb-[350px] md:pt-32 md:pb-48 lg:pt-40 lg:pb-86 relative" aria-label="Case study hero" style="min-height: 600px; height: 600px;">
      <div class="container">
        <div class="mx-auto relative max-w-[1200px]">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8 items-start">
            <!-- Left Column: Title, Customer, Categories -->
            <div class="md:col-span-8 lg:col-span-7 relative z-10">
              <h1 class="text-text-light mb-4 md:mb-6 leading-tight" style="font-family: 'Keep Calm', sans-serif; font-weight: 400; font-size: 36px;">
                {title}
              </h1>
              
              {displayCustomer ? (
                <p class="mb-4 md:mb-6" style="font-family: 'Keep Calm', sans-serif; font-weight: 400; font-size: 22px; color: #87FAE7;">
                  {displayCustomer}
                </p>
              ) : (
                <div class="mb-4 md:mb-6" style="height: 0;"></div>
              )}
              
              {categories.length > 0 ? (
                <p class="mb-8 md:mb-12" style="font-family: 'Mulish', sans-serif; font-weight: 400; font-size: 22px; color: #FFFFFF;">
                  Categories: {categories.join(', ')}
                </p>
              ) : (
                <div class="mb-8 md:mb-12" style="height: 0;"></div>
              )}
            </div>
            
            <!-- Right Column: Spacer for absolute positioned image -->
            <div class="md:col-span-4 lg:col-span-5"></div>
          </div>
          
        </div>
      </div>
    </section>

    <!-- White Introduction Section (overlapping) -->
    <section class="section section-light -mt-16 md:-mt-24 lg:-mt-32 relative z-10 pt-[320px] pb-8 md:pt-12 md:pb-12" style="overflow: visible;">
      <div class="container">
        <div class="mx-auto relative" style="max-width: 1200px;">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
            <!-- Left Column: Intro Text -->
            <div class="md:col-span-8 lg:col-span-7 relative z-10 mt-[180px] md:mt-0">
              {description && (
                <p class="text-text-dark leading-relaxed" style="font-family: 'Mulish', sans-serif; font-weight: 700; font-size: 24px;">
                  {description}
                </p>
              )}
            </div>
            <!-- Right Column: Spacer for image overlap -->
            <div class="md:col-span-4 lg:col-span-5"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Mobile Hero Image (centered, overlapping both dark and white sections) -->
    {heroImage && (
      <div class="md:hidden flex justify-center absolute left-1/2 z-20" style="width: 100%; max-width: 1200px; padding: 0 1.5rem; top: 350px; transform: translateX(-50%);">
        <div class="mobile-image-container" style="width: 333px; height: 484px;">
          <img
            src={heroImage.src}
            alt={heroImageAlt || `${title} - case study hero image`}
            class="block h-auto w-full"
            loading="eager"
          />
        </div>
      </div>
    )}
    
    <!-- Desktop/Tablet Hero Image Container -->
    {heroImage && (
      <div
        class="
          hidden md:block
          pointer-events-none
          absolute md:top-12 lg:top-16
          w-full
          z-20
        "
        style="max-width: 1200px; left: 50%; transform: translateX(-50%); padding: 0 1.5rem;"
        aria-hidden="true"
      >
        <div class="flex justify-end">
          <div class="mobile-image-container" style="width: 333px; height: 484px;">
            <img
              src={heroImage.src}
              alt={heroImageAlt || `${title} - case study hero image`}
              class="
                block h-auto pointer-events-auto w-full
                md:drop-shadow-xl
              "
              loading="eager"
            />
          </div>
        </div>
      </div>
    )}
  </div>

  <!-- Main Content Section with Light Grey Background -->
  <main id="content" class="section section-intro pt-6 pb-12 md:py-16">
    <div class="container">
      <div class="mx-auto" style="max-width: 1200px;">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
          <!-- Left Column: Main Text Content -->
          <div class="md:col-span-7 lg:col-span-8 order-1">
            <div class="case-study-content markdown-content">
              <Content />
            </div>
          </div>
          
          <!-- Right Column: Placeholder Containers -->
          <div class="md:col-span-5 lg:col-span-4 order-2 pt-8">
            <div class="flex flex-col gap-6">
              <!-- Quote Card -->
              <QuoteCard
                quote="A quote from a customer explaining the project, the impact of the work and why they loved working with us"
                customerName="Customer name"
                customerOrganisation="Customer organisation"
              />
              
              <!-- Black Container -->
              <div class="statistics-block">
                <!-- Search Icon SVG -->
                <img 
                  src={smallLensIcon.src} 
                  alt="Statistics icon" 
                  width="50.24" 
                  height="49.93" 
                  class="flex-shrink-0"
                />
                {statistic ? (
                  <p class="statistics-text">
                    {statistic}
                  </p>
                ) : (
                  <p class="statistics-text">
                    <!-- Placeholder for statistic -->
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div class="bg-bg-dark w-full">
    <GetInTouch />
    <Footer />
  </div>
</Layout>
