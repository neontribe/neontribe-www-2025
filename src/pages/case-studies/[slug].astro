---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import GetInTouch from '../../components/sections/GetInTouch.astro';
import QuoteCard from '../../components/Testimonials/QuoteCard.astro';
import smallLensIcon from '../../content/case-studies/images/Small-lens.svg';
import microCaseStudyBadge from '../../content/case-studies/images/micro-case-study.svg';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies');
  return caseStudies.map((entry) => {
    const slug = entry.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'case-studies'>;
}

const { entry } = Astro.props;
const slug = Astro.params.slug;

const { Content } = await entry.render();
const {
  title,
  description,
  customer,
  categories = [],
  statistic,
  heroImage,
  heroImageAlt,
  heroImageLandscape = false,
  cardImage,
  tags = [],
  quote,
  quoteAuthor,
  quoteOrganisation,
  quoteAvatar,
  challenges,
  howWeHelped,
  isMicro = false,
} = entry.data;

// Special exception for infosecurity case study
const displayCustomer = slug === 'infosecurity' ? 'Infosec at Neontribe' : customer;
---

<Layout 
  title={title} 
  description={description}
  ogType="article"
  ogImage={cardImage?.src}
  ogImageAlt={heroImageAlt || `${title} - case study`}
>
  <Header />
  <div class="relative" style="overflow: visible;">
    <!-- Dark Hero Section -->
    <section class={`section section-dark pt-8 sm:pt-20 md:pt-24 lg:pt-32 relative ${isMicro ? 'pb-8 sm:pb-12 md:pb-16 lg:pb-20' : heroImageLandscape ? 'pb-8 lg:pb-86 landscape-hero' : 'pb-8 sm:pb-40 md:pb-48 lg:pb-86'}`} aria-label="Case study hero">
      <div class="container">
        <div class={`mx-auto relative max-w-[1200px] ${isMicro ? '' : heroImageLandscape ? 'lg:min-h-[320px] lg:h-[320px]' : 'sm:min-h-[280px] md:min-h-[320px] sm:h-[280px] md:h-[320px]'}`}>
          {isMicro && (
            <div class="sm:hidden flex justify-center mb-6">
              <div class="micro-badge-hero-container" style="width: 150px;">
                <img
                  src={microCaseStudyBadge.src}
                  alt=""
                  style="width: 100%; height: auto;"
                />
                <div class="micro-badge-text">
                  <span>micro</span>
                  <span>case</span>
                  <span>study</span>
                </div>
              </div>
            </div>
          )}
          
          <div class={`grid grid-cols-1 sm:grid-cols-12 gap-6 md:gap-8 ${isMicro ? 'items-center' : 'items-start'}`}>
            <!-- Left Column: Title, Customer, Categories -->
            <div class={`relative z-10 ${heroImageLandscape ? 'sm:col-span-12 lg:col-span-6' : 'sm:col-span-7 lg:col-span-7'}`}>
              <h1 class="text-text-light mb-4 md:mb-5 leading-tight case-study-title" style="font-family: var(--font-button); font-weight: var(--font-regular);">
                {title}
              </h1>
              
              {displayCustomer ? (
                <p class="mb-3 md:mb-4 leading-normal" style="font-family: var(--font-button); font-weight: var(--font-regular); font-size: var(--text-xl); color: #87FAE7;">
                  {displayCustomer}
                </p>
              ) : (
                <div class="mb-3 md:mb-4" style="height: 0;"></div>
              )}
              
              {categories.length > 0 ? (
                <p class={`leading-normal ${isMicro ? 'mb-0' : heroImageLandscape ? 'mb-2 lg:mb-12' : 'mb-8 md:mb-12'}`} style="font-family: var(--font-body); font-weight: var(--font-regular); font-size: var(--text-xl); color: #FFFFFF;">
                  Categories: {categories.join(', ')}
                </p>
              ) : (
                <div class={`${isMicro ? '' : heroImageLandscape ? 'mb-2 lg:mb-12' : 'mb-8 md:mb-12'}`} style="height: 0;"></div>
              )}
            </div>
            
            <!-- Right Column: Micro case study badge OR spacer for hero image -->
            <div class={`justify-end items-center ${heroImageLandscape ? 'hidden lg:flex lg:col-span-6' : 'hidden sm:flex sm:col-span-5 lg:col-span-5'}`}>
              {isMicro && (
                <div class="micro-badge-hero-container">
                  <img
                    src={microCaseStudyBadge.src}
                    alt=""
                    class="micro-badge-hero"
                  />
                  <div class="micro-badge-text">
                    <span>micro</span>
                    <span>case</span>
                    <span>study</span>
                  </div>
                </div>
              )}
            </div>
          </div>
          
          {heroImage && !isMicro && heroImageLandscape && (
            <div class="lg:hidden flex justify-center mt-8" style="padding: 0 1.5rem;">
              <div class="mobile-image-container relative" style="max-width: 600px; width: 100%;">
                <img
                  src={heroImage.src}
                  alt={heroImageAlt || `${title} - case study hero image`}
                  class="block h-auto w-full drop-shadow-xl"
                  loading="eager"
                  style="object-fit: contain;"
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- Mobile Portrait Hero Image -->
    {heroImage && !isMicro && !heroImageLandscape && (
      <div class="flex justify-center mb-8 sm:hidden -mt-16" style="padding: 0 1.5rem;">
        <div class="mobile-image-container relative" style="max-width: 333px; width: 100%; aspect-ratio: 333 / 484;">
          <img
            src={heroImage.src}
            alt={heroImageAlt || `${title} - case study hero image`}
            class="block h-auto w-full drop-shadow-xl"
            loading="eager"
            style="object-fit: contain;"
          />
        </div>
      </div>
    )}

    <!-- White Introduction Section -->
    {!isMicro && (
      <section class="section section-light relative z-10 pt-8 md:pt-12 md:pb-12 -mt-16 sm:-mt-20 md:-mt-24 lg:-mt-32" style="overflow: visible;">
        <div class="container">
          <div class="mx-auto relative" style="max-width: 1200px;">
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-6 md:gap-8">
              <!-- Left Column: Intro Text - full width for landscape images -->
              <div class={`relative z-10 sm:mt-0 ${heroImageLandscape ? 'col-span-12' : 'sm:col-span-8 lg:col-span-7'}`}>
                {description && (
                  <p class="text-text-dark leading-relaxed" style="font-family: var(--font-body); font-weight: var(--font-bold); font-size: var(--text-xl);">
                    {description}
                  </p>
                )}
              </div>
              <!-- Right Column: Spacer for image overlap - only for portrait images -->
              {!heroImageLandscape && <div class="sm:col-span-4 lg:col-span-5"></div>}
            </div>
          </div>
        </div>
      </section>
    )}
    
    <!-- Desktop Hero Image Overlay -->
    {heroImage && !isMicro && (
      <div
        class={`
          pointer-events-none
          absolute w-full
          hero-image-overlay
          ${heroImageLandscape ? 'hidden lg:block hero-image-landscape lg:top-40' : 'hidden sm:block sm:top-40 md:top-48 lg:top-52'}
        `}
        style="max-width: 1200px; left: 50%; transform: translateX(-50%); padding: 0 1.5rem; z-index: 30;"
        aria-hidden="true"
      >
        <div class="flex justify-end">
          <div class={`relative ${heroImageLandscape ? 'landscape-hero-size' : 'portrait-hero-size'}`}>
            <img
              src={heroImage.src}
              alt={heroImageAlt || `${title} - case study hero image`}
              class="
                block h-auto pointer-events-auto w-full
                drop-shadow-xl
              "
              loading="eager"
            />
          </div>
        </div>
      </div>
    )}
  </div>

  <main id="content" class="section section-intro pt-6 pb-12 md:py-16">
    <div class="container">
      <div class="mx-auto" style="max-width: 1200px;">
        {isMicro ? (
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
            <div class="md:col-span-5 lg:col-span-5 order-1 md:order-2">
              {cardImage && (
                <div class="micro-content-image-wrapper">
                  <img
                    src={cardImage.src}
                    alt={heroImageAlt || `${title} - case study image`}
                    class="micro-content-image"
                    loading="eager"
                  />
                </div>
              )}
            </div>
            
            <div class="md:col-span-7 lg:col-span-7 order-2 md:order-1">
              {challenges && (
                <div class="mb-8">
                  <h2 class="micro-section-heading" style="font-family: var(--font-button); font-weight: var(--font-bold); font-size: var(--text-2xl); margin-bottom: var(--typography-spacing-md);">
                    Challenges
                  </h2>
                  <p class="text-text-dark leading-relaxed" style="font-family: var(--font-body); font-size: var(--text-base);">
                    {challenges}
                  </p>
                </div>
              )}
              
              {howWeHelped && howWeHelped.length > 0 && (
                <div>
                  <h2 class="micro-section-heading" style="font-family: var(--font-button); font-weight: var(--font-bold); font-size: var(--text-2xl); margin-bottom: var(--typography-spacing-md);">
                    How we helped
                  </h2>
                  <ul class="list-disc pl-6 space-y-2">
                    {howWeHelped.map((item) => (
                      <li class="text-text-dark leading-relaxed" style="font-family: var(--font-body); font-size: var(--text-base);">
                        {item}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
            <!-- Left Column: Main Text Content -->
            <div class="md:col-span-7 lg:col-span-8 order-1">
              <div class="case-study-content markdown-content">
                <Content />
              </div>
            </div>
            
            {(quote && quoteAuthor && quoteOrganisation) || statistic ? (
              <div class="md:col-span-5 lg:col-span-4 order-2 pt-8">
                <div class="flex flex-col gap-6 case-study-sidebar">
                  {quote && quoteAuthor && quoteOrganisation ? (
                    <div>
                      <h3 class="quote-section-heading" style="font-family: var(--font-button); font-weight: var(--font-regular); font-size: var(--text-lg); margin-bottom: var(--typography-spacing-sm);">
                        {quoteOrganisation} say:
                      </h3>
                      <QuoteCard
                        quote={quote}
                        customerName={quoteAuthor}
                        customerOrganisation={quoteOrganisation}
                        avatar={quoteAvatar ? { src: quoteAvatar.src, alt: `${quoteAuthor} from ${quoteOrganisation}` } : undefined}
                      />
                    </div>
                  ) : null}
                  
                  {statistic ? (
                    <div class="statistics-block">
                      <img 
                        src={smallLensIcon.src} 
                        alt="Statistics icon" 
                        width="50.24" 
                        height="49.93" 
                        class="flex-shrink-0"
                      />
                      <p class="statistics-text">
                        {statistic}
                      </p>
                    </div>
                  ) : null}
                </div>
              </div>
            ) : null}
          </div>
        )}
      </div>
    </div>
  </main>
  
  <div class="bg-bg-dark w-full">
    <GetInTouch />
    <Footer />
  </div>
</Layout>

<style>
  .case-study-title {
    font-size: 28px;
    line-height: 1.2;
  }
  
  @media (min-width: 640px) {
    .case-study-title {
      font-size: 36px;
    }
  }
  
  @media (min-width: 768px) {
    .case-study-title {
      font-size: 40px;
    }
  }
  
  @media (min-width: 1024px) {
    .case-study-title {
      font-size: 48px;
    }
  }
  
  .hero-image-overlay {
    z-index: 30 !important;
  }
  
  /* Fix for all mobile and tablet landscape (640px-1023px) when not in stack mode */
  @media (min-width: 640px) and (max-width: 1023px) {
    /* Force text wrapping to prevent going under image */
    .case-study-title {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      hyphens: auto;
      max-width: 100%;
    }
    
    section.section-dark:not(.landscape-hero) {
      padding-bottom: 20rem !important;
    }
    
    section.section-light {
      margin-top: -12rem !important;
    }
    
    .landscape-hero ~ section.section-light {
      margin-top: -2rem !important;
    }
    
    section.section-dark:not(.landscape-hero) [class*="sm:col-span-8"],
    section.section-dark:not(.landscape-hero) [class*="md:col-span-8"] {
      padding-right: 2.5rem !important;
      max-width: calc(100% - 2.5rem) !important;
    }
    
    section.section-light [class*="sm:col-span-8"],
    section.section-light [class*="md:col-span-8"] {
      padding-right: 2.5rem !important;
      max-width: calc(100% - 2.5rem) !important;
    }
    
    section.section-dark p {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      max-width: 100% !important;
    }
  }
  
  /* Specific fix for iPhone SE landscape (667px)*/
  @media (min-width: 667px) and (max-width: 667px) {
    .case-study-title {
      word-wrap: break-word !important;
      overflow-wrap: anywhere !important;
      word-break: break-word !important;
      hyphens: auto;
      max-width: 100%;
      white-space: normal !important;
    }
    
    section.section-dark [class*="sm:col-span-8"] {
      padding-right: 3rem !important;
      max-width: calc(100% - 3rem) !important;
    }
    
    section.section-light [class*="sm:col-span-8"] {
      padding-right: 3rem !important;
      max-width: calc(100% - 3rem) !important;
    }
  }
  
  @media (min-width: 740px) and (max-width: 740px) {
    section.section-dark [class*="sm:col-span-8"],
    section.section-dark [class*="md:col-span-8"] {
      padding-right: 3.5rem !important;
      max-width: calc(100% - 3.5rem) !important;
    }
    
    section.section-light [class*="sm:col-span-8"],
    section.section-light [class*="md:col-span-8"] {
      padding-right: 3.5rem !important;
      max-width: calc(100% - 3.5rem) !important;
    }
  }
  
  @media (min-width: 720px) and (max-width: 720px) {
    section.section-dark [class*="sm:col-span-8"],
    section.section-dark [class*="md:col-span-8"] {
      padding-right: 3.5rem !important;
      max-width: calc(100% - 3.5rem) !important;
    }
    
    section.section-light [class*="sm:col-span-8"],
    section.section-light [class*="md:col-span-8"] {
      padding-right: 3.5rem !important;
      max-width: calc(100% - 3.5rem) !important;
    }
  }
  
  @media (min-width: 640px) and (max-width: 767px) {
    .hero-image-overlay {
      top: 10rem !important;
      z-index: 30 !important;
    }
  }
  
  @media (min-width: 768px) and (max-width: 1023px) {
    .hero-image-overlay {
      top: 12rem !important;
      z-index: 30 !important;
    }
  }
  
  @media (min-width: 1024px) {
    .hero-image-overlay {
      z-index: 30 !important;
    }
  }
  
  section.section-dark .relative.z-10,
  section.section-light .relative.z-10 {
    z-index: 10;
    position: relative;
  }
  
  .micro-badge-hero-container {
    position: relative;
    display: inline-block;
  }
  
  .micro-badge-hero {
    width: 180px;
    height: auto;
    display: block;
  }
  
  .micro-badge-text {
    position: absolute;
    top: 42%;
    left: 42%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-family: var(--font-heading);
    font-weight: var(--font-bold);
    font-size: 14px;
    line-height: 1.2;
    text-align: center;
  }
  
  @media (min-width: 768px) {
    .micro-badge-hero {
      width: 200px;
    }
    .micro-badge-text {
      font-size: 16px;
    }
  }
  
  @media (min-width: 1024px) {
    .micro-badge-hero {
      width: 240px;
    }
    .micro-badge-text {
      font-size: 18px;
    }
  }
  
  @media (min-width: 1280px) {
    .micro-badge-hero {
      width: 280px;
    }
    .micro-badge-text {
      font-size: 20px;
    }
  }
  
  .micro-content-image-wrapper {
    width: 100%;
  }
  
  .micro-content-image {
    width: 100%;
    height: auto;
  }
  
  @media (min-width: 1280px) {
    .micro-content-image-wrapper {
      margin-right: -3rem;
    }
    
    .micro-content-image {
      width: calc(100% + 3rem);
      max-width: none;
    }
  }
  
  .portrait-hero-size {
    width: 333px;
    height: 484px;
  }
  
  .landscape-hero-size {
    width: 480px;
    max-width: 45%;
  }
  
  @media (min-width: 1280px) {
    .landscape-hero-size {
      width: 520px;
      max-width: 50%;
    }
  }
  
  .hero-image-landscape {
    top: 12rem !important;
  }
  
  @media (min-width: 1280px) {
    .hero-image-landscape {
      top: 10rem !important;
    }
  }
</style>
