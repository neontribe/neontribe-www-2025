---
import Button from '../Button/Button.astro';
import neontribeLogo from '../../assets/neontribe-logo.svg';
import dxwFamilyRaw from '../../assets/dxwFamily.svg?raw';
const currentPath = Astro.url.pathname;
---

<header id="site-header" class="section section-dark w-full">
  <a href="#content" class="skip-link">Skip to main content</a>

  <div class="w-full flex justify-center bg-bg-dark">
    <div class="w-full md:max-w-[1420px] md:mx-auto flex items-center justify-between py-0 header-container overflow-hidden bg-bg-dark">
      <div class="px-6 sm:px-8 md:px-6 lg:px-8 xl:px-10 pr-24 sm:pr-20 md:pr-16 lg:pr-20 flex items-center justify-between w-full min-w-0 overflow-hidden bg-bg-dark">
    <!-- Logo -->
    <div class="flex-shrink-0 flex items-center gap-2 sm:gap-3">
      <a href="/" aria-label="Go to homepage" class="block pl-2 sm:pl-3 md:pl-0">
        <!-- Logo on mobile portrait (< 640px) -->
        <img src={neontribeLogo.src} alt="Neontribe" class="block sm:hidden h-6 w-auto" />
        <!-- Logo on mobile landscape and tablet (640px-1279px) -->
        <img src={neontribeLogo.src} alt="Neontribe" class="hidden sm:block xl:hidden h-8 w-auto" />
        <!-- Logo on desktop (1280px+) -->
        <img src={neontribeLogo.src} alt="Neontribe" class="hidden xl:block h-8 w-auto" />
      </a>
      <a href="https://www.dxw.com" target="_blank" rel="noopener noreferrer" class="dxw-family-link" aria-label="Part of the dxw family - visit dxw website">
        <Fragment set:html={dxwFamilyRaw} />
      </a>
    </div>

    <!-- Desktop Navigation - visible only from desktop (1280px+) -->
    <nav class="hidden xl:flex xl:flex-row xl:flex-nowrap items-center gap-6 flex-shrink xl:ml-6 min-w-0" aria-label="Main navigation">
      <a
        href="/case-studies"
        class={`nav-link ${currentPath === '/case-studies' ? 'active' : ''}`}
        aria-current={currentPath === '/case-studies' ? 'page' : undefined}
      >Case Studies</a>

      <a
        href="/how-we-work"
        class={`nav-link ${currentPath === '/how-we-work' ? 'active' : ''}`}
        aria-current={currentPath === '/how-we-work' ? 'page' : undefined}
      >How We Work</a>

      <a
        href="/advice-service"
        class={`nav-link ${currentPath === '/advice-service' ? 'active' : ''}`}
        aria-current={currentPath === '/advice-service' ? 'page' : undefined}
      >Advice Service</a>
    </nav>

    <!-- Button wrapper - visible only from desktop (1280px+) -->
    <div class="hidden xl:flex flex-shrink-0 xl:ml-6 header-button-wrapper">
      <Button href="/talk-to-us" variant="teal" size="sm" class="whitespace-nowrap">Talk to us</Button>
    </div>

    <!-- Mobile Menu Button - visible on mobile, tablet portrait and landscape (up to 1279px) -->
    <button
      class="mobile-toggle xl:hidden flex flex-col justify-center items-center gap-[3px] w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 bg-transparent border-0 cursor-pointer p-1 sm:p-2 lg:p-2.5 rounded absolute right-4 sm:right-6 md:right-4 lg:right-6"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Toggle navigation menu"
    >
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <nav id="mobile-menu" class="mobile-menu hidden" aria-label="Mobile navigation" aria-hidden="true">
    <div class="mobile-content">
      <a href="/case-studies"  class={`mobile-link ${currentPath === '/case-studies'  ? 'active' : ''}`} aria-current={currentPath === '/case-studies' ? 'page' : undefined}>Case Studies</a>
      <a href="/how-we-work"   class={`mobile-link ${currentPath === '/how-we-work'   ? 'active' : ''}`} aria-current={currentPath === '/how-we-work' ? 'page' : undefined}>How We Work</a>
      <a href="/advice-service" class={`mobile-link ${currentPath === '/advice-service' ? 'active' : ''}`} aria-current={currentPath === '/advice-service' ? 'page' : undefined}>Advice Service</a>
      <div class="mobile-cta">
        <Button href="/talk-to-us" variant="teal" size="sm">Talk to us</Button>
      </div>
    </div>
  </nav>
</header>

<!-- Global rules that must escape component scoping -->
<style is:global>
  body.menu-open { overflow: hidden; position: fixed; width: 100%; }
  body.menu-open .mobile-toggle {
    position: fixed;
    top: 12px;
    right: 16px;
    z-index: 1101;
    background: transparent;
  }
</style>

<style>
  .skip-link{
    position:absolute; top:-40px; left:6px;
    background:var(--color-accent-amethyst); color:var(--color-text-light);
    padding:8px; border-radius:4px; z-index:1000; transition:top .3s;
  }
  .skip-link:focus{ top:6px; }

  .dxw-family-link {
    display: block;
  }
  .dxw-family-link svg {
    height: 1.25rem;
    width: auto;
  }
  @media (min-width: 400px) {
    .dxw-family-link svg {
      height: 1.5rem;
    }
  }
  @media (min-width: 640px) {
    .dxw-family-link svg {
      height: 2rem;
    }
  }
  .dxw-family-link .dxw-family-text {
    fill: white;
    transition: fill 0.2s ease;
  }
  .dxw-family-link:hover .dxw-family-text {
    fill: #8751F8 !important;
  }

  .mobile-toggle{ z-index:1101; }
  .mobile-toggle:focus{ outline:2px solid var(--color-accent-turquoise); outline-offset:2px; }
  .mobile-toggle:hover{ background:rgba(255,255,255,.1); }
  .hamburger-line{ 
    width:18px; 
    height:2px; 
    background:var(--color-text-light); 
    transition:transform .3s, opacity .3s, background .2s ease;
  }
  .mobile-toggle:hover .hamburger-line{ background:#48E9CE; }
  .mobile-toggle[aria-expanded="true"] .hamburger-line{ background:var(--color-accent-turquoise); }
  
  /* More space between logo and hamburger on mobile portrait */
  @media (max-width: 639px) {
    .mobile-toggle { right: 0.5rem !important; }
  }
  
  /* Base close state transform - for mobile (< 640px) - regular X */
  .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(1){ 
    transform: rotate(45deg);
    position: absolute;
    top: 50%;
    left: 50%;
    margin-left: -9px;
    margin-top: -1px;
  }
  .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(2){ 
    opacity: 0;
  }
  .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(3){ 
    transform: rotate(-45deg);
    position: absolute;
    top: 50%;
    left: 50%;
    margin-left: -9px;
    margin-top: -1px;
  }
  
  /* Larger hamburger menu on mobile landscape (640px-1023px) */
  @media (min-width: 640px) and (max-width: 1023px) {
    .hamburger-line{ width:19px; height:2.5px; }
    .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(1),
    .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(3) {
      margin-left: -9.5px;
      margin-top: -1.25px;
    }
  }
  
  /* Larger hamburger menu on tablet (1024px-1279px) */
  @media (min-width: 1024px) and (max-width: 1279px) {
    .hamburger-line{ width:22px; height:3px; }
    .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(1),
    .mobile-toggle[aria-expanded="true"] .hamburger-line:nth-child(3) {
      margin-left: -11px;
      margin-top: -1.5px;
    }
  }

  .mobile-menu{
    position:fixed; inset:0; background:rgba(0,0,0,.95); z-index:1000;
    display:none; opacity:0; visibility:hidden; pointer-events:none;
    align-items:center; justify-content:center;
    overflow-y:auto;
    transition:opacity .3s, visibility .3s;
  }
  .mobile-menu:not(.hidden){
    display:flex; opacity:1; visibility:visible; pointer-events:auto;
  }

  .mobile-content{
    display:flex; flex-direction:column; align-items:center; text-align:center;
    gap:1.5rem; padding:2rem; width:100%; max-width:400px;
    min-height:100vh; box-sizing:border-box; justify-content:center;
  }
  @supports (height: 100dvh){
    .mobile-content{ min-height:100dvh; }
  }

  .mobile-link{
    color:var(--color-text-light); 
    text-decoration:none; 
    font-size:1.5rem; 
    font-weight:500;
    padding:12px 24px; 
    min-height:44px; 
    display:flex; 
    align-items:center; 
    transition:color .2s ease, text-decoration .2s ease, text-decoration-color .2s ease, text-decoration-thickness .2s ease;
    white-space:nowrap;
  }
  .mobile-link.active{ 
    color:var(--color-accent-turquoise); 
    text-decoration:none;
  }
  .mobile-link:hover,
  .mobile-link.active:hover{ 
    color:#48E9CE !important; 
    text-decoration:underline !important;
    text-decoration-color:#48E9CE !important;
    text-decoration-thickness:2px !important;
    text-underline-offset:0.25rem !important;
  }
  .mobile-link:focus{ 
    outline:2px solid var(--color-accent-turquoise); 
    outline-offset:2px; 
    border-radius:2px; 
  }
  .mobile-link:active{ 
    outline:none; 
  }

  .mobile-cta{ margin-top:1rem; }

  @media (max-width:480px){
    .mobile-content{ padding:1.5rem 1rem; }
    .mobile-link{ font-size: var(--text-lg); padding:12px 20px; }
  }
</style>

<script is:inline>
  function initMobileMenu(){
    const root   = document.getElementById('site-header');
    const toggle = root?.querySelector('.mobile-toggle');
    const menu   = root?.querySelector('#mobile-menu');
    const links  = root?.querySelectorAll('.mobile-link') ?? [];
    const body   = document.body;
    if(!toggle || !menu) return;

    let isOpen = false;

    const closeMenu = ()=>{
      isOpen = false;
      toggle.setAttribute('aria-expanded','false');
      menu.setAttribute('aria-hidden','true');
      menu.classList.add('hidden');
      body.classList.remove('menu-open');
    };

    const openMenu = ()=>{
      isOpen = true;
      toggle.setAttribute('aria-expanded','true');
      menu.setAttribute('aria-hidden','false');
      menu.classList.remove('hidden');
      body.classList.add('menu-open');
    };

    toggle.addEventListener('click', ()=> (isOpen ? closeMenu() : openMenu()));

    
    Array.from(links).forEach((a) => {
      if (a instanceof HTMLAnchorElement) a.addEventListener('click', closeMenu);
    });

    document.addEventListener('keydown', (e) => { if(e.key==='Escape' && isOpen) closeMenu(); });
    menu.addEventListener('click', (e) => { if(e.target === menu) closeMenu(); });
    window.addEventListener('resize', () => { if(window.innerWidth >= 1280 && isOpen) closeMenu(); });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  } else {
    initMobileMenu();
  }
</script>


