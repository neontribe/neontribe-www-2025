---
import QuoteCard from '../Testimonials/QuoteCard.astro';
import Button from '../Button/Button.astro';
import { getCollection } from 'astro:content';

const caseStudies = await getCollection('case-studies');
const MAX_QUOTE_LENGTH = 300;

const caseStudiesWithQuotes = caseStudies
  .filter((study) => {
    const hasQuote = study.data.quote && study.data.quoteAuthor && study.data.quoteOrganisation;
    if (!hasQuote) return false;
    return study.data.quote.length <= MAX_QUOTE_LENGTH;
  })
  .slice(0, 3);
---

<section class="w-full bg-bg-light py-8 md:py-20">
  <div class="w-full md:max-w-[1336px] md:mx-auto px-8 md:px-10">
    <div class="p-2 md:p-0">
      <h2 class="font-heading text-4xl md:text-5xl font-bold text-[#090909] mb-8 md:mb-12">
        Who we've been working with
      </h2>
      
      {caseStudiesWithQuotes.length > 0 ? (
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 xl:gap-8 mb-6 xl:mb-12">
          {caseStudiesWithQuotes.map((study) => (
            <QuoteCard
              quote={study.data.quote}
              customerName={study.data.quoteAuthor}
              customerOrganisation={study.data.quoteOrganisation}
              avatar={study.data.quoteAvatar ? { src: study.data.quoteAvatar.src, alt: `${study.data.quoteAuthor} from ${study.data.quoteOrganisation}` } : undefined}
            />
          ))}
        </div>
      ) : null}
      
      <div class="flex justify-center md:justify-start">
        <div class="w-full md:w-auto">
          <Button href="/case-studies" variant="teal" size="md" class="w-full md:w-auto">
            See more case studies
          </Button>
        </div>
      </div>
    </div>
  </div>
</section>

