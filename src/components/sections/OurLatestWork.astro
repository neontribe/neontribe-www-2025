---
import Button from '../Button/Button.astro';
import { getCollection } from 'astro:content';
import { sortCaseStudiesByDateDesc } from '../../utils/dateSorting';
import cardImage from '../../assets/CardImage.svg';
import arcCardImage from '../../content/case-studies/images/arc-card.png';
import infosecCardImage from '../../content/case-studies/images/infosec-card.png';
import momoCardImage from '../../content/case-studies/images/momo-card.png';
import npcCardImage from '../../content/case-studies/images/npc-card.png';
import parentingSmartCardImage from '../../content/case-studies/images/parenting-smart-card.png';
import realChatAiCardImage from '../../content/case-studies/images/real-chat-ai-card.png';


const caseStudies = await getCollection('case-studies');

// Sort by date in descending order (newest first)
const sortedCaseStudies = sortCaseStudiesByDateDesc(caseStudies);

// Get the most recent case study
const latestCaseStudy = sortedCaseStudies[0];

// Extract data from latest case study
const slug = latestCaseStudy ? latestCaseStudy.id.replace(/\.md$/, '') : null;
const customer = slug === 'infosecurity' ? 'Infosec at Neontribe' : (latestCaseStudy?.data.customer || 'No case studies available');
const projectName = latestCaseStudy?.data.projectName || '';
const description = latestCaseStudy?.data.description || '';
const challenges = latestCaseStudy?.data.challenges || '';
const howWeHelped = latestCaseStudy?.data.howWeHelped || [];


const cardImageMap = {
  'arc': arcCardImage,
  'infosecurity': infosecCardImage,
  'momo': momoCardImage,
  'npc': npcCardImage,
  'place2be': parentingSmartCardImage,
  'ncs-realchat-ai': realChatAiCardImage,
};
const cardImageSrc = slug ? (cardImageMap[slug] || cardImage) : cardImage;
const imageAlt = latestCaseStudy?.data.heroImageAlt || latestCaseStudy?.data.title || 'Case study image';

// Link to latest case study
const buttonHref = slug ? `/case-studies/${slug}` : null;
---

<section class="w-full bg-bg-light relative">
  <div class="w-screen bg-[#090909] md:bg-bg-dark relative -mt-[77px] z-10 left-1/2 -translate-x-1/2">
    <div class="w-full md:max-w-[1336px] md:mx-auto h-[77px] min-h-[77px] relative px-6 md:px-0">
      <div class="flex items-center justify-center md:justify-start h-full bg-[#4B00E7] w-fit md:w-full mx-auto md:mx-0 px-16 md:px-10">
        <span class="text-white font-heading text-xl md:text-2xl font-bold whitespace-nowrap">
          Our latest work <span class="text-[#48E9CE] inline">↓</span>
        </span>
      </div>
    </div>
  </div>
  
  <div class="w-full md:max-w-[1336px] md:mx-auto relative">
    <div class="bg-white flex flex-col w-full md:max-w-[1336px] min-h-[509px]">
      <div class="grid grid-cols-1 md:grid-cols-[1.2fr_1fr] gap-0 items-start md:items-stretch flex-1 h-full">
        <div class="flex flex-col order-2 md:order-1 p-8 md:p-10">
          <h2 class="font-heading text-2xl font-bold text-[#090909] mb-2">
            {customer}
          </h2>
          {projectName && (
            <h3 class="font-heading text-xl font-bold text-brand-amethyst mb-4">
              {projectName}
            </h3>
          )}
          <p class="font-body text-base font-normal text-[#090909] mb-6">
            {description}
          </p>
          
          {challenges && (
            <div class="mb-6">
              <h4 class="font-heading text-lg font-bold text-[#090909] mb-3">Challenges</h4>
              <p class="font-body text-base font-normal text-[#090909] leading-relaxed">
                {challenges}
              </p>
            </div>
          )}
          
          {howWeHelped.length > 0 && (
            <div class="mb-6">
              <h4 class="font-heading text-lg font-bold text-[#090909] mb-3">How we helped</h4>
              <ul class="list-none space-y-2">
                {howWeHelped.map((item) => (
                  <li class="font-body text-base font-normal text-[#090909] leading-relaxed flex items-start">
                    <span class="mr-2">•</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          <div class="mt-8 latest-work-button-wrapper flex justify-center md:justify-start">
            <div class="w-full md:w-auto">
              {buttonHref ? (
                <Button href={buttonHref} variant="primary" size="md" class="w-full md:w-auto">
                  read full case study
                </Button>
              ) : (
                <Button variant="primary" size="md" class="w-full md:w-auto">
                  read full case study
                </Button>
              )}
            </div>
          </div>
        </div>

        <div class="w-full md:self-stretch order-1 md:order-2">
          {cardImageSrc ? (
            <div class="relative w-full h-full overflow-hidden">
              <img
                src={typeof cardImageSrc === 'string' ? cardImageSrc : cardImageSrc.src}
                alt={imageAlt}
                class="w-full h-full object-cover block"
              />
            </div>
          ) : (
            <div class="w-full min-h-[260px] md:min-h-[300px] h-full bg-bg-light flex items-center justify-center">
              <span class="text-neutral-grey font-body text-base">
                Case study image
              </span>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .latest-work-button-wrapper a,
  .latest-work-button-wrapper button {
    font-weight: var(--button-font-weight) !important;
    font-size: var(--button-font-size) !important;
    font-family: var(--button-font-family) !important;
    line-height: var(--button-line-height) !important;
  }
</style>
