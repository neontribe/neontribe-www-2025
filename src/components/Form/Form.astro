---
export interface Props {
  action?: string;
  method?: 'get' | 'post';
  title?: string;
  description?: string;
  class?: string;
  formId?: string;
  successMessage?: string;
  errorMessage?: string;
}

const {
  action = '/',
  method = 'post',
  title,
  description,
  class: className = '',
  formId,
  successMessage = 'Thank you! Your message has been sent successfully.',
  errorMessage = 'Sorry, there was an error submitting your form. Please try again.',
} = Astro.props;

const uniqueFormId = formId || `form-${Math.random().toString(36).substring(2, 11)}`;
---

<form 
  id={uniqueFormId}
  action={action} 
  method={method}
  class={`form ${className}`}
  novalidate
  data-formbold-form
  data-form-id={uniqueFormId}
>
  {title && (
    <h2 class="form-title">{title}</h2>
  )}
  {description && (
    <p class="form-description">{description}</p>
  )}
  
  <!-- Success message (hidden by default) -->
  <div 
    class="form-message form-message-success" 
    role="alert" 
    aria-live="polite"
    hidden
  >
    <p>{successMessage}</p>
  </div>
  
  <!-- Error message (hidden by default) -->
  <div 
    class="form-message form-message-error" 
    role="alert" 
    aria-live="assertive"
    hidden
  >
    <p>{errorMessage}</p>
  </div>
  
  <div class="form-fields">
    <slot />
  </div>
</form>

<script is:inline>
  (function() {
    var forms = document.querySelectorAll('form[data-formbold-form]');
    if (forms.length === 0) return;
    
    var form = forms[0];
    if (!form || form.tagName !== 'FORM') return;
    
    var successMessage = form.querySelector('.form-message-success');
    var errorMessage = form.querySelector('.form-message-error');
    var submitButton = form.querySelector('button[type="submit"]');
    var originalButtonText = submitButton ? (submitButton.textContent || 'Submit') : 'Submit';
    
    function getFieldLabel(input) {
      var id = input.id;
      if (!id) return 'This field';
      var label = form.querySelector('label[for="' + id + '"]');
      if (label) {
        return label.textContent.replace(/\*/g, '').trim();
      }
      return 'This field';
    }

    function showFieldError(input, message) {
      var errorId = input.id + '-error';
      var errorElement = form.querySelector('#' + errorId);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.hidden = false;
      }
      input.setAttribute('aria-invalid', 'true');
      input.classList.add('form-input-invalid');
    }

    function clearFieldError(input) {
      var errorId = input.id + '-error';
      var errorElement = form.querySelector('#' + errorId);
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.hidden = true;
      }
      input.setAttribute('aria-invalid', 'false');
      input.classList.remove('form-input-invalid');
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (successMessage) successMessage.hidden = true;
      if (errorMessage) errorMessage.hidden = true;
      
      var allFields = form.querySelectorAll('input, textarea');
      for (var i = 0; i < allFields.length; i++) {
        clearFieldError(allFields[i]);
      }
      
      var formData = new FormData(form);
      var requiredFields = form.querySelectorAll('[required]');
      var isValid = true;
      var firstInvalidField = null;
      
      for (var j = 0; j < requiredFields.length; j++) {
        var input = requiredFields[j];
        var value = input.value ? input.value.trim() : '';
        var fieldLabel = getFieldLabel(input);
        
        if (!value) {
          isValid = false;
          showFieldError(input, 'Please enter your ' + fieldLabel.toLowerCase());
          if (!firstInvalidField) {
            firstInvalidField = input;
          }
          continue;
        }
        
        if (input.type === 'email' && value) {
          var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            isValid = false;
            showFieldError(input, 'Please enter a valid email address');
            if (!firstInvalidField) {
              firstInvalidField = input;
            }
            continue;
          }
        }
      }
      
      if (!isValid) {
        if (firstInvalidField) {
          firstInvalidField.focus();
          firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        return;
      }
      
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
      }
      
      fetch(form.action, {
        method: form.method,
        body: formData,
      }).then(function(response) {
        if (response.ok) {
          if (successMessage) {
            successMessage.hidden = false;
            form.reset();
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        } else {
          if (errorMessage) {
            errorMessage.hidden = false;
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
      }).catch(function(error) {
        if (errorMessage) {
          errorMessage.hidden = false;
          errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }).finally(function() {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      });
    });

    var allInputs = form.querySelectorAll('input, textarea');
    for (var k = 0; k < allInputs.length; k++) {
      var input = allInputs[k];
      input.addEventListener('input', function() {
        if (this.getAttribute('aria-invalid') === 'true') {
          clearFieldError(this);
        }
      });
    }
  })();
</script>

<style>
  .form {
    width: 100%;
  }
  
  .form-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
  }
  
  .form-description {
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-secondary);
  }
  
  .form-fields {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .form-message {
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-md);
  }
  
  .form-message-success {
    background-color: var(--color-success-bg);
    color: var(--color-success);
    border: 1px solid var(--color-success);
  }
  
  .form-message-error {
    background-color: var(--color-error-bg);
    color: var(--color-error);
    border: 1px solid var(--color-error);
  }
  
  .form-input-invalid {
    border-color: var(--color-error) !important;
  }
  
  .form-field-error {
    color: var(--color-error);
    font-size: var(--text-sm);
    margin-top: var(--spacing-xs);
  }
</style>
